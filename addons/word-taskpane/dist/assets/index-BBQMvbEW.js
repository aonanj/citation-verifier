(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=r(t);fetch(t.href,s)}})();const A=window.location.protocol==="https:"?"https://localhost:8000":"http://localhost:8000",L=A;let w=null,h=null,y=null,g=null,m=null,d=null,E=null;function b(e){w||(w=document.getElementById("status")),w&&(w.textContent=e)}function x(e){h||(h=document.getElementById("response")),h&&(typeof e=="string"?h.textContent=e:h.textContent=JSON.stringify(e,null,2))}function B(e){E||(E=document.getElementById("text-preview")),E&&(E.textContent=e)}function I(){g||(g=document.getElementById("result-container")),m||(m=document.getElementById("result-summary")),d||(d=document.getElementById("citations")),m&&(m.innerHTML=""),d&&(d.innerHTML=""),x(""),B(""),g&&(g.hidden=!0)}function S(e){const n=document.createElement("span");if(n.classList.add("status-badge"),e){const r=e.toLowerCase();r==="verified"?n.classList.add("verified"):r==="warning"?n.classList.add("warning"):(r==="error"||r==="no_match")&&n.classList.add("error"),n.textContent=e}else n.textContent="unknown";return n}function O(e){if(g||(g=document.getElementById("result-container")),m||(m=document.getElementById("result-summary")),d||(d=document.getElementById("citations")),!g||!m||!d){console.warn("Result container not found in DOM.");return}const n=e.citations??[],r=n.length,o=new Map;for(const l of n){const i=(l.status??"unknown").toLowerCase();o.set(i,(o.get(i)??0)+1)}m.innerHTML="";const t=document.createElement("li");if(t.textContent=`Total citations: ${r}`,m.appendChild(t),o.size>0)for(const[l,i]of o.entries()){const a=document.createElement("li"),c=l.replace(/_/g," "),u=c.charAt(0).toUpperCase()+c.slice(1);a.textContent=`${u}: ${i}`,m.appendChild(a)}if(d.innerHTML="",r===0){const l=document.createElement("p");l.textContent="No citations returned.",d.appendChild(l)}else{const l=n.slice(0,5);if(l.forEach(i=>{const a=document.createElement("article");a.classList.add("citation-card");const c=document.createElement("div");c.classList.add("citation-header");const u=document.createElement("h3");u.textContent=i.normalized_citation??i.resource_key;const p=S(i.status);if(c.appendChild(u),c.appendChild(p),a.appendChild(c),i.type){const f=document.createElement("p");f.textContent=`Type: ${i.type}`,a.appendChild(f)}if(i.substatus){const f=document.createElement("p");f.textContent=`Detail: ${i.substatus}`,a.appendChild(f)}const C=i.occurrences?.[0];if(C?.matched_text){const f=document.createElement("p");f.textContent=`Example: ${C.matched_text}`,a.appendChild(f)}const v=i.occurrences?.length??0;if(v>1){const f=document.createElement("p");f.textContent=`${v} occurrences detected.`,a.appendChild(f)}d.appendChild(a)}),n.length>l.length){const i=document.createElement("p");i.textContent=`${n.length-l.length} more citation(s) available in the raw response below.`,d.appendChild(i)}}x(e);const s=e.extracted_text?e.extracted_text.slice(0,500):"No preview available.";B(s),g.hidden=!1}function $(e){if(typeof e=="string"){const r=atob(e),o=new Uint8Array(r.length);for(let t=0;t<r.length;t+=1)o[t]=r.charCodeAt(t);return o}if(e==null)throw new Error("Received empty slice data.");if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e)){const r=e;return new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}if(Array.isArray(e))return new Uint8Array(e);const n=Object.prototype.toString.call(e);throw new Error(`Unsupported slice data format: ${n}`)}function T(e){const n=e.reduce((t,s)=>t+s.byteLength,0),r=new Uint8Array(n);let o=0;for(const t of e)r.set(t,o),o+=t.byteLength;return r}async function U(){return new Promise((e,n)=>{Office.context.document.getFileAsync(Office.FileType.Compressed,{sliceSize:65536},r=>{if(r.status!==Office.AsyncResultStatus.Succeeded||!r.value){n(new Error(r.error?.message??"Unable to read document."));return}const o=r.value,t=o.sliceCount,s=new Array(t);let l=0;const i=()=>{if(l===t)try{const c=s.map((p,C)=>{if(!p)throw new Error(`Missing slice ${C}`);return p}),u=T(c);o.closeAsync(),e(u)}catch(c){o.closeAsync(),n(c instanceof Error?c:new Error(String(c)))}},a=c=>{o.getSliceAsync(c,u=>{if(u.status!==Office.AsyncResultStatus.Succeeded||!u.value){o.closeAsync(),n(new Error(u.error?.message??"Unable to read document slice."));return}try{const p=$(u.value.data);s[c]=p,l+=1,i()}catch(p){o.closeAsync(),n(p instanceof Error?p:new Error(String(p)))}})};for(let c=0;c<t;c+=1)a(c)})})}async function D(e){const n=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),r=new File([n],"document.docx",{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"}),o=new FormData;o.append("document",r);const t=await fetch(`${L}/api/verify`,{method:"POST",body:o});if(!t.ok){const s=await t.text();throw new Error(`Verifier returned ${t.status}: ${s}`)}return t.json()}async function M(){b("Preparing document..."),I();try{y||(y=document.getElementById("verify-document")),y&&(y.disabled=!0);const e=await U();b("Contacting verifier...");const n=await D(e),r=Array.isArray(n.citations)?n.citations.length:0;b(`Verification complete: ${r} citations returned.`),O(n)}catch(e){const n=e instanceof Error?e.message:String(e);b("Verification failed."),x(n)}finally{y&&(y.disabled=!1)}}Office.onReady(e=>{e.host!==Office.HostType.Word&&console.warn(`Unsupported host: ${e.host}`),w=document.getElementById("status"),h=document.getElementById("response"),y=document.getElementById("verify-document"),g=document.getElementById("result-container"),m=document.getElementById("result-summary"),d=document.getElementById("citations"),E=document.getElementById("text-preview"),y?y.addEventListener("click",()=>{M()}):console.warn("Verify button not found in DOM.")});
